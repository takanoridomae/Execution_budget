# 実行予算管理システム 要件定義書

## プロジェクト概要

### システム名
実行予算管理システム (Execution Budget Management System)

### システム目的
建設業界における現場単位での予算管理・コスト追跡・収支管理を効率化し、複数現場の総合的な財務状況をリアルタイムで把握するためのWebアプリケーション。

### 開発背景
- 現場単位での詳細な予算管理の必要性
- リアルタイムでの収支状況把握による早期意思決定
- 複数デバイス・複数ユーザーでの情報共有
- 証憑管理（画像・書類）の電子化
- オフライン対応とデータ同期

## 技術仕様

### 技術スタック
- **フロントエンド**: React 19.1.0 + TypeScript 4.9.5
- **UIライブラリ**: Material-UI (MUI) 7.2.0
- **ルーティング**: React Router DOM 7.6.3
- **バックエンド**: Firebase
  - Firestore（データベース）
  - Firebase Storage（ファイルストレージ）
- **開発ツール**: Create React App 5.0.1
- **デプロイメント**: PWA対応、Docker対応

### アーキテクチャ
- **クライアントサイド**: SPA（Single Page Application）
- **データ管理**: React Context API
- **ストレージ戦略**: ハイブリッド（Firebase + LocalStorage）
- **状態管理**: React Hooks + Context
- **レスポンシブデザイン**: モバイルファースト

## 機能要件

### 1. 現場管理機能

#### 1.1 現場情報管理
**目的**: 建設現場の基本情報を管理
- 現場名、説明、コメント、稼働状況の登録・編集・削除
- 現場に関連する画像・書類の添付
- 現場のアクティブ/非アクティブ管理
- 作成日時・更新日時の自動記録

#### 1.2 現場選択機能
- ダッシュボードでの現場選択
- 選択状態の永続化（localStorage）
- 選択現場に基づく情報表示

### 2. カテゴリー管理機能

#### 2.1 現場別カテゴリー管理
**目的**: 現場毎の支出カテゴリーを詳細管理
- カテゴリー名、説明、コメント、予算金額の設定
- カテゴリー毎の画像・書類添付
- カテゴリーのアクティブ/非アクティブ管理
- 現場との関連付け

#### 2.2 予算設定
- カテゴリー毎の予算金額設定
- 年月単位での予算管理
- 予算使用状況の可視化

### 3. 取引管理機能

#### 3.1 収入管理
- **現場収入**: 現場毎の売上入力
- 固定カテゴリー「売上」
- 金額、内容、日付、画像・書類添付

#### 3.2 支出管理
- **現場支出**: カテゴリー別支出入力
- 金額、内容、日付、カテゴリー選択
- 画像・書類添付機能
- 支出詳細の検索・フィルタリング

#### 3.3 取引フォーム
- タブ式インターフェース（収入・支出）
- リアルタイムバリデーション
- 画像・書類の複数添付
- レスポンシブUI

### 4. ダッシュボード機能

#### 4.1 統計表示
- **全体統計**:
  - 稼働現場数
  - 総予算金額
  - 支出件数
  - 総支出金額
- **現場別統計**:
  - 現場毎の予算・収入・支出
  - カテゴリー別支出内訳
  - 予算使用率

#### 4.2 現場詳細表示
- 選択現場の詳細情報
- カテゴリー一覧と使用状況
- 添付ファイル表示
- 収支サマリー

### 5. カレンダー機能

#### 5.1 取引カレンダー
- 月次カレンダービュー
- 日付別取引一覧
- 収入・支出の視覚的表示
- 日付クリックでの詳細表示

#### 5.2 取引詳細
- 選択日の取引一覧
- 取引内容の表示・編集
- 削除機能

### 6. レポート機能

#### 6.1 現場別レポート
- 現場毎の収支レポート
- グラフによる可視化（Recharts使用）
- 期間指定での集計
- 予算対比分析

#### 6.2 全体レポート
- 全現場の総合レポート
- 現場間比較
- 月次・年次集計

### 7. ファイル管理機能

#### 7.1 画像管理
- **保存方式**: ハイブリッド（Firebase Storage + LocalStorage）
- **圧縮**: 自動リサイズ（600x400px、品質70%）
- **形式**: JPEG、PNG、WebP対応
- **制限**: 10MB以下

#### 7.2 書類管理
- **対応形式**: PDF、Word、Excel、PowerPoint、画像
- **保存方式**: ハイブリッド（Firebase Storage + LocalStorage）
- **制限**: 10MB以下
- **プレビュー**: ブラウザ内表示・ダウンロード

#### 7.3 ストレージ整合性
- ローカルストレージとFirebaseの同期チェック
- 不整合検出・修復機能
- ストレージ使用量監視

## 非機能要件

### 1. パフォーマンス要件
- **初期ロード時間**: 3秒以内
- **画面遷移**: 1秒以内
- **データ同期**: バックグラウンド実行
- **オフライン対応**: LocalStorage活用

### 2. 可用性要件
- **稼働率**: 99.5%以上
- **PWA対応**: オフライン利用可能
- **マルチデバイス**: PC・タブレット・スマートフォン対応

### 3. セキュリティ要件
- **アクセス制御**: Firebase Security Rules
- **データ暗号化**: HTTPS通信
- **ファイル制限**: 形式・サイズチェック
- **入力検証**: フロントエンド・バックエンド双方

### 4. 操作性要件
- **レスポンシブデザイン**: Material Design準拠
- **マルチタッチ**: タッチデバイス最適化
- **キーボードナビゲーション**: アクセシビリティ対応

## データ設計

### 1. メインエンティティ

#### 1.1 Site（現場）
```typescript
interface Site {
  id: string;
  name: string;
  description?: string;
  comment?: string;
  isActive: boolean;
  createdAt: string;
  updatedAt: string;
  imageUrls?: string[];        // Firebase Storage
  imageIds?: string[];         // LocalStorage
  documentUrls?: string[];     // Firebase Storage
  documentIds?: string[];      // LocalStorage
}
```

#### 1.2 SiteCategory（現場カテゴリー）
```typescript
interface SiteCategory {
  id: string;
  siteId: string;
  name: string;
  description?: string;
  comment?: string;
  budgetAmount: number;
  isActive: boolean;
  createdAt: string;
  updatedAt: string;
  imageUrls?: string[];
  imageIds?: string[];
  documentUrls?: string[];
  documentIds?: string[];
}
```

#### 1.3 SiteIncome（現場収入）
```typescript
interface SiteIncome {
  id: string;
  amount: number;
  content: string;
  date: string;
  type: 'income';
  siteId: string;
  category: '売上';
  imageUrls?: string[];
  imageIds?: string[];
  documentUrls?: string[];
  documentIds?: string[];
}
```

#### 1.4 SiteExpense（現場支出）
```typescript
interface SiteExpense {
  id: string;
  amount: number;
  content: string;
  date: string;
  type: 'expense';
  siteId: string;
  categoryId: string;
  imageUrls?: string[];
  imageIds?: string[];
  documentUrls?: string[];
  documentIds?: string[];
}
```

#### 1.5 SiteBudgetSettings（現場予算設定）
```typescript
interface SiteBudgetSettings {
  siteId: string;
  totalBudget: number;
  categories: SiteCategory[];
  comment?: string;
  yearMonth: string; // "2024-01"形式
}
```

### 2. Firebase Collections
- **Sites**: 現場情報
- **SiteCategories**: 現場別カテゴリー
- **SiteTransactions**: 現場別取引（収入・支出）
- **SiteBudgetSettings**: 現場別予算設定

### 3. LocalStorage Keys
- **selected_site_id**: 選択中の現場ID
- **budget_settings_[yearMonth]**: 年月別予算設定
- **image_[entityId]_[imageId]**: 画像データ
- **document_[entityId]_[documentId]**: 書類データ

## UI/UX設計

### 1. 画面構成

#### 1.1 メイン画面（Home）
- **レイアウト**: カレンダー + 取引詳細（2ペイン）
- **機能**: 取引入力フォーム、日付選択、取引一覧
- **レスポンシブ**: モバイルではスライド表示

#### 1.2 ダッシュボード（Dashboard）
- **レイアウト**: 統計カード + 現場一覧
- **機能**: 現場選択、統計表示、クイックアクション
- **ナビゲーション**: 現場管理・カテゴリー管理への遷移

#### 1.3 レポート（Report）
- **レイアウト**: グラフ + 詳細表
- **機能**: 期間選択、現場選択、データ可視化

#### 1.4 現場管理（SiteManagement）
- **レイアウト**: 一覧 + 編集フォーム
- **機能**: CRUD操作、ファイル添付、検索・フィルタ

#### 1.5 カテゴリー管理（CategoryManagement）
- **レイアウト**: 現場選択 + カテゴリー一覧 + 編集フォーム
- **機能**: 現場別カテゴリー管理、予算設定

### 2. デザインシステム
- **カラーパレット**: Material Design準拠
- **タイポグラフィ**: Roboto フォント
- **アイコン**: Material Icons
- **コンポーネント**: Material-UI

### 3. ナビゲーション
- **サイドバー**: メインナビゲーション
- **タブ**: フォーム内の切り替え
- **ボタン**: CTA・アクション
- **モーダル**: 詳細表示・確認ダイアログ

## 開発・運用要件

### 1. 開発環境
- **パッケージマネージャー**: npm
- **ビルドツール**: Create React App
- **開発サーバー**: ローカル開発サーバー（ポート3000）
- **ホットリロード**: 開発時自動更新

### 2. デプロイメント
- **本番環境**: Firebase Hosting
- **ローカルネットワーク**: カスタムビルド対応
- **PWA**: オフライン対応
- **Docker**: コンテナ化対応

### 3. 監視・ログ
- **Firebase Analytics**: 使用状況分析
- **Console Logging**: 開発時デバッグ
- **エラーハンドリング**: ユーザーフレンドリーなエラー表示

### 4. バックアップ・復旧
- **Firebase**: 自動バックアップ
- **LocalStorage**: デバイス依存
- **データエクスポート**: 将来的な実装予定

## 制約・前提条件

### 1. 技術的制約
- **ブラウザ対応**: Chrome、Firefox、Safari（最新2バージョン）
- **Node.js**: 16.x以上
- **Firebase**: Blazeプラン（従量課金）
- **インターネット接続**: 同期に必要

### 2. 運用制約
- **同時ユーザー数**: 制限なし（Firebase依存）
- **データ容量**: Firebase制限内
- **ファイルサイズ**: 10MB以下
- **課金**: Firebase使用量に依存

### 3. セキュリティ制約
- **認証**: 現在未実装（将来的な拡張予定）
- **アクセス制御**: IP制限なし
- **データ暗号化**: Firebase標準

## 今後の拡張予定

### 1. 認証機能
- Firebase Authentication導入
- 役割ベースアクセス制御
- 多人数での協調作業

### 2. 詳細レポート
- 高度な分析機能
- カスタムダッシュボード
- データエクスポート（CSV、PDF）

### 3. 通知機能
- 予算超過アラート
- 締切リマインダー
- プッシュ通知

### 4. 外部連携
- 会計ソフト連携
- API提供
- インポート・エクスポート機能

## 付録

### A. 設定ファイル
- `package.json`: 依存関係
- `tsconfig.json`: TypeScript設定
- `firebase.ts`: Firebase設定
- `Dockerfile`: コンテナ設定

### B. セットアップガイド
- `daily-startup-guide.md`: 日常起動手順
- `firebase-setup-instructions.md`: Firebase設定
- `local-network-deployment-guide.md`: ローカル展開

### C. セキュリティルール
- `firestore.rules`: Firestore セキュリティルール
- `storage.rules`: Firebase Storage セキュリティルール

---

**作成日**: 2025年9月19日  
**バージョン**: 1.0  
**作成者**: AI Assistant  
**承認者**: [未設定]  

*この要件定義書は、現在の実装状況に基づいて作成されています。新機能の追加や仕様変更に応じて、適宜更新される予定です。*
